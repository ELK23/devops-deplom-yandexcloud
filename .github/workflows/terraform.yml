name: Terraform Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: infrastructure_deploy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Write YC SA key (from base64) and validate
        run: |
          set -euo pipefail
          echo '${{ secrets.YC_KEY_JSON_B64 }}' | base64 -d > yc-key.json
          # Validate JSON (won't print contents)
          jq -e . yc-key.json >/dev/null 2>&1 || { echo "YC_KEY_JSON_B64 decodes to invalid JSON"; exit 1; }
          # Sanity checks
          test -s yc-key.json || { echo "Decoded yc-key.json is empty"; exit 1; }
          echo "yc-key.json size: $(wc -c < yc-key.json) bytes"
          # Optional: check expected fields exist
          jq -r '.service_account_id, .id' yc-key.json >/dev/null 2>&1 || { echo "Missing fields in key JSON"; exit 1; }

      - name: Terraform Init (remote state in Yandex Object Storage)
        run: |
          set -euo pipefail
          terraform init -no-color 2>&1 | tee init.log
        env:
          AWS_ACCESS_KEY_ID:     ${{ secrets.YC_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.YC_SECRET_KEY }}
          YC_SERVICE_ACCOUNT_KEY_FILE: yc-key.json
          AWS_EC2_METADATA_DISABLED: "true"
          TF_LOG: INFO
          TF_LOG_PATH: tf-init-debug.log

      - name: Terraform Apply (stream logs)
        run: |
          set -euo pipefail
          terraform apply -auto-approve -no-color -input=false \
            -parallelism=2 \
            -var="cloud_id=${{ secrets.YC_CLOUD_ID }}" \
            -var="folder_id=${{ secrets.YC_FOLDER_ID }}" \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -var="access_key=${{ secrets.YC_ACCESS_KEY }}" \
            -var="secret_key=${{ secrets.YC_SECRET_KEY }}" \
            -var="service_account_id=${{ secrets.YC_SERVICE_ACCOUNT_ID }}" \
            -var="mysql_root_password=${{ secrets.MYSQL_ROOT_PASSWORD }}" \
            2>&1 | tee apply.log
        env:
          AWS_ACCESS_KEY_ID:     ${{ secrets.YC_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.YC_SECRET_KEY }}
          YC_SERVICE_ACCOUNT_KEY_FILE: yc-key.json
          AWS_EC2_METADATA_DISABLED: "true"
          TF_LOG: INFO
          TF_LOG_PATH: tf-apply-debug.log

      - name: Show last 200 lines of apply log
        if: always()
        run: |
          echo "===== tail -n 200 apply.log ====="
          tail -n 200 apply.log || true
          echo "===== tail -n 200 tf-apply-debug.log ====="
          tail -n 200 tf-apply-debug.log || true

      - name: Show Outputs
        run: |
          echo "master_public_ip=$(terraform output -raw k8s_master_public_ip)"
          echo "master_private_ip=$(terraform output -raw k8s_master_private_ip)"
          echo "worker_b_ip=$(terraform output -raw k8s_worker_b_ip)"
          echo "worker_d_ip=$(terraform output -raw k8s_worker_d_ip)"
        env:
          AWS_ACCESS_KEY_ID:     ${{ secrets.YC_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.YC_SECRET_KEY }}
          AWS_EC2_METADATA_DISABLED: "true"
